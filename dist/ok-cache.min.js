/*!
 * ok-cache v1.0.0 
 * (c) 2017 fjc0k
 * Released under the MIT License.
 */
!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):t.OkCache=n()}(this,function(){"use strict";function t(t,n){return n={exports:{}},t(n,n.exports),n.exports}var n="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},e=t(function(t){!function(n){function e(){}function o(t,n){return function(){t.apply(n,arguments)}}function r(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],a(t,this)}function i(t,n){for(;3===t._state;)t=t._value;return 0===t._state?void t._deferreds.push(n):(t._handled=!0,void r._immediateFn(function(){var e=1===t._state?n.onFulfilled:n.onRejected;if(null===e)return void(1===t._state?u:c)(n.promise,t._value);var o;try{o=e(t._value)}catch(t){return void c(n.promise,t)}u(n.promise,o)}))}function u(t,n){try{if(n===t)throw new TypeError("A promise cannot be resolved with itself.");if(n&&("object"==typeof n||"function"==typeof n)){var e=n.then;if(n instanceof r)return t._state=3,t._value=n,void f(t);if("function"==typeof e)return void a(o(e,n),t)}t._state=1,t._value=n,f(t)}catch(n){c(t,n)}}function c(t,n){t._state=2,t._value=n,f(t)}function f(t){2===t._state&&0===t._deferreds.length&&r._immediateFn(function(){t._handled||r._unhandledRejectionFn(t._value)});for(var n=0,e=t._deferreds.length;n<e;n++)i(t,t._deferreds[n]);t._deferreds=null}function s(t,n,e){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof n?n:null,this.promise=e}function a(t,n){var e=!1;try{t(function(t){e||(e=!0,u(n,t))},function(t){e||(e=!0,c(n,t))})}catch(t){if(e)return;e=!0,c(n,t)}}var p=setTimeout;r.prototype.catch=function(t){return this.then(null,t)},r.prototype.then=function(t,n){var o=new this.constructor(e);return i(this,new s(t,n,o)),o},r.all=function(t){var n=Array.prototype.slice.call(t);return new r(function(t,e){function o(i,u){try{if(u&&("object"==typeof u||"function"==typeof u)){var c=u.then;if("function"==typeof c)return void c.call(u,function(t){o(i,t)},e)}n[i]=u,0===--r&&t(n)}catch(t){e(t)}}if(0===n.length)return t([]);for(var r=n.length,i=0;i<n.length;i++)o(i,n[i])})},r.resolve=function(t){return t&&"object"==typeof t&&t.constructor===r?t:new r(function(n){n(t)})},r.reject=function(t){return new r(function(n,e){e(t)})},r.race=function(t){return new r(function(n,e){for(var o=0,r=t.length;o<r;o++)t[o].then(n,e)})},r._immediateFn="function"==typeof setImmediate&&function(t){setImmediate(t)}||function(t){p(t,0)},r._unhandledRejectionFn=function(t){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",t)},r._setImmediateFn=function(t){r._immediateFn=t},r._setUnhandledRejectionFn=function(t){r._unhandledRejectionFn=t},t.exports?t.exports=r:n.Promise||(n.Promise=r)}(n)});window.Promise||(window.Promise=e);var o=function(t,n){if(!t)throw new Error(n||"Expected true, got"+t)},r=function(){for(var t=[],n=arguments.length;n--;)t[n]=arguments[n];for(var e=null,o=t.length-1,r=0;r<o&&(e="function"==typeof t[r]?t[r]():t[r],null===e);r++);return e=null===e?"function"==typeof t[o]?t[o]():t[o]:e},i=function(t,n){for(var e in t)t.hasOwnProperty(e)&&n(t[e],e)},u=function(t){return!!t&&("object"==typeof t||"function"==typeof t)&&"function"==typeof t.then},c=function(){this.data={}};c.prototype.has=function(t){return t in this.data},c.prototype.get=function(t){return this.has(t)?void 0===this.data[t]?null:this.data[t]:null},c.prototype.keys=function(){return Object.keys(this.data)},c.prototype.all=function(){return this.data},c.prototype.set=function(t,n){return this.data[t]=n},c.prototype.remove=function(t){return delete this.data[t]},c.prototype.count=function(){return Object.keys(this.data).length},c.prototype.clear=function(){return this.data={},!0};var f=function(t){void 0===t&&(t="local"),o(["local","session"].indexOf(t)!==-1,"Storage type must be local or session"),this.storage=window[t+"Storage"]};f.prototype.has=function(t){return null!==this.storage.getItem(t)},f.prototype.get=function(t){var n=null;try{n=JSON.parse(this.storage.getItem(t))}catch(t){}return n},f.prototype.keys=function t(){for(var n=this,t=[],e=this.count(),o=0;o<e;o++)t.push(n.storage.key(o));return t},f.prototype.all=function t(){for(var n=this,t={},e=this.keys(),o=0;o<e.length;o++)t[e[o]]=n.get(e[o]);return t},f.prototype.set=function(t,n){return this.storage.setItem(t,JSON.stringify(n)),n},f.prototype.remove=function(t){return this.storage.removeItem(t)},f.prototype.count=function(){return this.storage.length},f.prototype.clear=function(){return this.storage.clear()};var s=function(t){function n(){t.call(this,"session")}return t&&(n.__proto__=t),n.prototype=Object.create(t&&t.prototype),n.prototype.constructor=n,n}(f),a=function(t){function n(){t.call(this,"local")}return t&&(n.__proto__=t),n.prototype=Object.create(t&&t.prototype),n.prototype.constructor=n,n}(f),p={session:c,sessionStorage:s,localStorage:a},h=function(t){var n=t.prefix;void 0===n&&(n="");var e=t.driver;void 0===e&&(e="localStorage");var r=t.debug;void 0===r&&(r=!1),o(p[e],"The "+e+" driver is not found"),this.prefix=n,this.driver=e,this.cache=new p[e],this.$cache=new p.session};return h.prototype.$key=function(t){return this.prefix+t},h.prototype.$value=function(t,n,e){return void 0===n&&(n=null),void 0===e&&(e=null),null===e?"function"==typeof t?t():t:"function"==typeof t?t(n,e):n(t)},h.prototype.$shouldAsync=function(t){return"function"==typeof t&&t.length>0},h.prototype.$wrapper=function(t,n){return n?function(t){return new Promise(function(n,e){return t(function(t,e){return void 0===e&&(e=!1),e?null!==t&&n(t):n(t),t},e)})}(t):t(function(t){return t},null)},h.prototype.get=function(t,n,e,o){var i=this;void 0===n&&(n=null),void 0===e&&(e=!1),void 0===o&&(o=!1);var u=o||this.$shouldAsync(n);return this.$wrapper(function(o,u){var c=i.$key(t);return r(function(){return o(e?null:i.$cache.get(c),!0)},function(){var t=i.cache.get(c);return e||null===t||i.$cache.set(c,t),o(t,!0)},function(){return i.$value(n,o,u)})},u)},h.prototype.getMany=function(t,n){var e=this;if(void 0===n&&(n=!1),Array.isArray(t)){var o=t,r={};return o.forEach(function(t){return r[t]=e.get(t,null,n)}),r}for(var i=t,u=!1,c=Object.keys(i),f=c.length,s=0;s<f;s++){var a=c[s];if(e.$shouldAsync(i[a])){u=!0;break}}if(u)return new Promise(function(t,o){var r=c.map(function(t){return e.get(t,i[t],n,!0)});Promise.all(r).then(function(n){var e={};c.forEach(function(t,o){e[t]=n[o]}),t(e)},function(t){return o(t)})})},h.prototype.keys=function(){var t=this;return this.cache.keys().filter(function(n){return n.substr(0,t.prefix.length)===t.prefix}).map(function(n){return n.substr(t.prefix.length)})},h.prototype.all=function(){return this.getMany(this.keys())},h.prototype.put=function(t,n){var e=this;return t=this.$key(t),n=this.$value(n,t),n=void 0===n?null:n,["$cache","cache"].forEach(function(o){return e[o].set(t,n)}),!0},h.prototype.putMany=function(t){var n=this;return i(t,function(t,e){return n.put(e,t)}),!0},h.prototype.switch=function(t,n){return void 0===n&&(n=null),n="boolean"==typeof n?n:!this.get(t,!1),this.put(t,n),n},h.prototype.increment=function(t,n,e){void 0===n&&(n=1),void 0===e&&(e=1/0);var o=+this.get(t,0)+n;return this.put(t,Math.min(o,e)),o},h.prototype.decrement=function(t,n,e){void 0===n&&(n=1),void 0===e&&(e=-(1/0));var o=+this.get(t,0)-n;return this.put(t,Math.max(o,e)),o},h.prototype.remember=function(t,n,e){var o=this;if(void 0===e&&(e=!1),this.$shouldAsync(n))return new Promise(function(r,i){o.get(t,n,e,!0).then(function(n){o.put(t,n),r(n)},function(t){return i(t)})});var r=this.get(t,n,e);return this.put(t,r),r},h.prototype.rememberMany=function(t,n){var e=this;void 0===n&&(n=!1);var o=this.getMany(t,n);return u(o)?new Promise(function(t,n){o.then(function(n){i(n,function(t,n){e.put(n,t)}),t(n)},function(t){return n(t)})}):(i(o,function(t,n){e.put(n,t)}),o)},h.prototype.forget=function(t){var n=this,e=Array.isArray(t)?t:[t];return e.forEach(function(t){t=n.$key(t),["$cache","cache"].forEach(function(e){return n[e].remove(t)})}),!0},h.prototype.flush=function(){return this.forget(this.keys()),this},h.prototype.getPrefix=function(){return this.prefix},h.prototype.setPrefix=function(t){this.prefix=t},h.prototype.getDriver=function(){return this.driver},h.prototype.setDriver=function(t){this.driver=t},h});
