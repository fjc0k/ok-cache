/*!
 * ok-cache v1.0.1 
 * (c) 2017 fjc0k
 * Released under the MIT License.
 */
!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):t.OkCache=n()}(this,function(){"use strict";var t=function(t,n){if(!t)throw new Error(n||"Expected true, got"+t)},n=function(){for(var t=[],n=arguments.length;n--;)t[n]=arguments[n];for(var e=null,r=t.length-1,o=0;o<r&&(e="function"==typeof t[o]?t[o]():t[o],null===e);o++);return e=null===e?"function"==typeof t[r]?t[r]():t[r]:e},e=function(t,n){for(var e in t)t.hasOwnProperty(e)&&n(t[e],e)},r=function(t){return!!t&&("object"==typeof t||"function"==typeof t)&&"function"==typeof t.then},o=function(){this.data={}};o.prototype.has=function(t){return t in this.data},o.prototype.get=function(t){return this.has(t)?void 0===this.data[t]?null:this.data[t]:null},o.prototype.keys=function(){return Object.keys(this.data)},o.prototype.all=function(){return this.data},o.prototype.set=function(t,n){return this.data[t]=n},o.prototype.remove=function(t){return delete this.data[t]},o.prototype.count=function(){return Object.keys(this.data).length},o.prototype.clear=function(){return this.data={},!0};var i=function(n){void 0===n&&(n="local"),t(["local","session"].indexOf(n)!==-1,"Storage type must be local or session"),this.storage=window[n+"Storage"]};i.prototype.has=function(t){return null!==this.storage.getItem(t)},i.prototype.get=function(t){var n=null;try{n=JSON.parse(this.storage.getItem(t))}catch(t){}return n},i.prototype.keys=function t(){for(var n=this,t=[],e=this.count(),r=0;r<e;r++)t.push(n.storage.key(r));return t},i.prototype.all=function t(){for(var n=this,t={},e=this.keys(),r=0;r<e.length;r++)t[e[r]]=n.get(e[r]);return t},i.prototype.set=function(t,n){return this.storage.setItem(t,JSON.stringify(n)),n},i.prototype.remove=function(t){return this.storage.removeItem(t)},i.prototype.count=function(){return this.storage.length},i.prototype.clear=function(){return this.storage.clear()};var u=function(t){function n(){t.call(this,"session")}return t&&(n.__proto__=t),n.prototype=Object.create(t&&t.prototype),n.prototype.constructor=n,n}(i),c=function(t){function n(){t.call(this,"local")}return t&&(n.__proto__=t),n.prototype=Object.create(t&&t.prototype),n.prototype.constructor=n,n}(i),s=function(){};s.prototype.has=function(t){return null!==this.get(t)},s.prototype.get=function(t){var n=null;try{n=JSON.parse(wx.getStorageSync(t))}catch(t){}return n},s.prototype.keys=function(){return wx.getStorageInfoSync().keys},s.prototype.all=function t(){for(var n=this,t={},e=this.keys(),r=0;r<e.length;r++)t[e[r]]=n.get(e[r]);return t},s.prototype.set=function(t,n){return wx.setStorageSync(t,JSON.stringify(n)),n},s.prototype.remove=function(t){return wx.removeStorageSync(t)},s.prototype.count=function(){return this.keys().length},s.prototype.clear=function(){return wx.clearStorageSync()};var p={session:o,sessionStorage:u,localStorage:c,wxapp:s},f=function(n){var e=n.prefix;void 0===e&&(e="");var r=n.driver;void 0===r&&(r="localStorage");var o=n.promise;void 0===o&&(o=null),t(p[r],"The "+r+" driver is not found"),t(null!==o||void 0!==window.Promise,"Promise is required"),this.prefix=e,this.driver=r,this.cache=new p[r],this.$cache=new p.session,this.promise=null===o?window.Promise:o};return f.prototype.$key=function(t){return this.prefix+t},f.prototype.$value=function(t,n,e){return void 0===n&&(n=null),void 0===e&&(e=null),null===e?"function"==typeof t?t():t:"function"==typeof t?t(n,e):n(t)},f.prototype.$shouldAsync=function(t){return"function"==typeof t&&t.length>0},f.prototype.$wrapper=function(t,n){var e=this;return n?function(t){return new e.promise(function(n,e){return t(function(t,e){return void 0===e&&(e=!1),e?null!==t&&n(t):n(t),t},e)})}(t):t(function(t){return t},null)},f.prototype.get=function(t,e,r,o){var i=this;void 0===e&&(e=null),void 0===r&&(r=!1),void 0===o&&(o=!1);var u=o||this.$shouldAsync(e);return this.$wrapper(function(o,u){var c=i.$key(t);return n(function(){return o(r?null:i.$cache.get(c),!0)},function(){var t=i.cache.get(c);return r||null===t||i.$cache.set(c,t),o(t,!0)},function(){return i.$value(e,o,u)})},u)},f.prototype.getMany=function(t,n){var e=this;if(void 0===n&&(n=!1),Array.isArray(t)){var r=t,o={};return r.forEach(function(t){return o[t]=e.get(t,null,n)}),o}for(var i=t,u=!1,c=Object.keys(i),s=c.length,p=0;p<s;p++){var f=c[p];if(e.$shouldAsync(i[f])){u=!0;break}}if(u)return new this.promise(function(t,r){var o=c.map(function(t){return e.get(t,i[t],n,!0)});e.promise.all(o).then(function(n){var e={};c.forEach(function(t,r){e[t]=n[r]}),t(e)},function(t){return r(t)})})},f.prototype.keys=function(){var t=this;return this.cache.keys().filter(function(n){return n.substr(0,t.prefix.length)===t.prefix}).map(function(n){return n.substr(t.prefix.length)})},f.prototype.all=function(){return this.getMany(this.keys())},f.prototype.put=function(t,n){var e=this;return t=this.$key(t),n=this.$value(n,t),n=void 0===n?null:n,["$cache","cache"].forEach(function(r){return e[r].set(t,n)}),!0},f.prototype.putMany=function(t){var n=this;return e(t,function(t,e){return n.put(e,t)}),!0},f.prototype.switch=function(t,n){return void 0===n&&(n=null),n="boolean"==typeof n?n:!this.get(t,!1),this.put(t,n),n},f.prototype.increment=function(t,n,e){void 0===n&&(n=1),void 0===e&&(e=1/0);var r=+this.get(t,0)+n;return this.put(t,Math.min(r,e)),r},f.prototype.decrement=function(t,n,e){void 0===n&&(n=1),void 0===e&&(e=-(1/0));var r=+this.get(t,0)-n;return this.put(t,Math.max(r,e)),r},f.prototype.remember=function(t,n,e){var r=this;if(void 0===e&&(e=!1),this.$shouldAsync(n))return new this.promise(function(o,i){r.get(t,n,e,!0).then(function(n){r.put(t,n),o(n)},function(t){return i(t)})});var o=this.get(t,n,e);return this.put(t,o),o},f.prototype.rememberMany=function(t,n){var o=this;void 0===n&&(n=!1);var i=this.getMany(t,n);return r(i)?new this.promise(function(t,n){i.then(function(n){e(n,function(t,n){o.put(n,t)}),t(n)},function(t){return n(t)})}):(e(i,function(t,n){o.put(n,t)}),i)},f.prototype.forget=function(t){var n=this,e=Array.isArray(t)?t:[t];return e.forEach(function(t){t=n.$key(t),["$cache","cache"].forEach(function(e){return n[e].remove(t)})}),!0},f.prototype.flush=function(){return this.forget(this.keys()),this},f.prototype.getPrefix=function(){return this.prefix},f.prototype.setPrefix=function(t){this.prefix=t},f.prototype.getDriver=function(){return this.driver},f.prototype.setDriver=function(t){this.driver=t},f});
