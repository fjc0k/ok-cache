/*!
 * ok-cache v1.0.1 
 * (c) 2017 fjc0k
 * Released under the MIT License.
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.OkCache=e()}(this,function(){"use strict";function t(t,e){return e={exports:{}},t(e,e.exports),e.exports}var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},n=t(function(t){!function(e){function n(){}function o(t,e){return function(){t.apply(e,arguments)}}function r(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],a(t,this)}function i(t,e){for(;3===t._state;)t=t._value;return 0===t._state?void t._deferreds.push(e):(t._handled=!0,void r._immediateFn(function(){var n=1===t._state?e.onFulfilled:e.onRejected;if(null===n)return void(1===t._state?u:c)(e.promise,t._value);var o;try{o=n(t._value)}catch(t){return void c(e.promise,t)}u(e.promise,o)}))}function u(t,e){try{if(e===t)throw new TypeError("A promise cannot be resolved with itself.");if(e&&("object"==typeof e||"function"==typeof e)){var n=e.then;if(e instanceof r)return t._state=3,t._value=e,void f(t);if("function"==typeof n)return void a(o(n,e),t)}t._state=1,t._value=e,f(t)}catch(e){c(t,e)}}function c(t,e){t._state=2,t._value=e,f(t)}function f(t){2===t._state&&0===t._deferreds.length&&r._immediateFn(function(){t._handled||r._unhandledRejectionFn(t._value)});for(var e=0,n=t._deferreds.length;e<n;e++)i(t,t._deferreds[e]);t._deferreds=null}function s(t,e,n){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.promise=n}function a(t,e){var n=!1;try{t(function(t){n||(n=!0,u(e,t))},function(t){n||(n=!0,c(e,t))})}catch(t){if(n)return;n=!0,c(e,t)}}var p=setTimeout;r.prototype.catch=function(t){return this.then(null,t)},r.prototype.then=function(t,e){var o=new this.constructor(n);return i(this,new s(t,e,o)),o},r.all=function(t){var e=Array.prototype.slice.call(t);return new r(function(t,n){function o(i,u){try{if(u&&("object"==typeof u||"function"==typeof u)){var c=u.then;if("function"==typeof c)return void c.call(u,function(t){o(i,t)},n)}e[i]=u,0===--r&&t(e)}catch(t){n(t)}}if(0===e.length)return t([]);for(var r=e.length,i=0;i<e.length;i++)o(i,e[i])})},r.resolve=function(t){return t&&"object"==typeof t&&t.constructor===r?t:new r(function(e){e(t)})},r.reject=function(t){return new r(function(e,n){n(t)})},r.race=function(t){return new r(function(e,n){for(var o=0,r=t.length;o<r;o++)t[o].then(e,n)})},r._immediateFn="function"==typeof setImmediate&&function(t){setImmediate(t)}||function(t){p(t,0)},r._unhandledRejectionFn=function(t){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",t)},r._setImmediateFn=function(t){r._immediateFn=t},r._setUnhandledRejectionFn=function(t){r._unhandledRejectionFn=t},t.exports?t.exports=r:e.Promise||(e.Promise=r)}(e)});window.Promise||(window.Promise=n);var o=function(t,e){if(!t)throw new Error(e||"Expected true, got"+t)},r=function(){for(var t=[],e=arguments.length;e--;)t[e]=arguments[e];for(var n=null,o=t.length-1,r=0;r<o&&(n="function"==typeof t[r]?t[r]():t[r],null===n);r++);return n=null===n?"function"==typeof t[o]?t[o]():t[o]:n},i=function(t,e){for(var n in t)t.hasOwnProperty(n)&&e(t[n],n)},u=function(t){return!!t&&("object"==typeof t||"function"==typeof t)&&"function"==typeof t.then},c=function(){this.data={}};c.prototype.has=function(t){return t in this.data},c.prototype.get=function(t){return this.has(t)?void 0===this.data[t]?null:this.data[t]:null},c.prototype.keys=function(){return Object.keys(this.data)},c.prototype.all=function(){return this.data},c.prototype.set=function(t,e){return this.data[t]=e},c.prototype.remove=function(t){return delete this.data[t]},c.prototype.count=function(){return Object.keys(this.data).length},c.prototype.clear=function(){return this.data={},!0};var f=function(t){void 0===t&&(t="local"),o(["local","session"].indexOf(t)!==-1,"Storage type must be local or session"),this.storage=window[t+"Storage"]};f.prototype.has=function(t){return null!==this.storage.getItem(t)},f.prototype.get=function(t){var e=null;try{e=JSON.parse(this.storage.getItem(t))}catch(t){}return e},f.prototype.keys=function t(){for(var e=this,t=[],n=this.count(),o=0;o<n;o++)t.push(e.storage.key(o));return t},f.prototype.all=function t(){for(var e=this,t={},n=this.keys(),o=0;o<n.length;o++)t[n[o]]=e.get(n[o]);return t},f.prototype.set=function(t,e){return this.storage.setItem(t,JSON.stringify(e)),e},f.prototype.remove=function(t){return this.storage.removeItem(t)},f.prototype.count=function(){return this.storage.length},f.prototype.clear=function(){return this.storage.clear()};var s=function(t){function e(){t.call(this,"session")}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(f),a=function(t){function e(){t.call(this,"local")}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(f),p=function(){};p.prototype.has=function(t){return null!==this.get(t)},p.prototype.get=function(t){var e=null;try{e=JSON.parse(wx.getStorageSync(t))}catch(t){}return e},p.prototype.keys=function(){return wx.getStorageInfoSync().keys},p.prototype.all=function t(){for(var e=this,t={},n=this.keys(),o=0;o<n.length;o++)t[n[o]]=e.get(n[o]);return t},p.prototype.set=function(t,e){return wx.setStorageSync(t,JSON.stringify(e)),e},p.prototype.remove=function(t){return wx.removeStorageSync(t)},p.prototype.count=function(){return this.keys().length},p.prototype.clear=function(){return wx.clearStorageSync()};var h={session:c,sessionStorage:s,localStorage:a,wxapp:p},l=function(t){var e=t.prefix;void 0===e&&(e="");var n=t.driver;void 0===n&&(n="localStorage"),o(h[n],"The "+n+" driver is not found"),this.prefix=e,this.driver=n,this.cache=new h[n],this.$cache=new h.session};return l.prototype.$key=function(t){return this.prefix+t},l.prototype.$value=function(t,e,n){return void 0===e&&(e=null),void 0===n&&(n=null),null===n?"function"==typeof t?t():t:"function"==typeof t?t(e,n):e(t)},l.prototype.$shouldAsync=function(t){return"function"==typeof t&&t.length>0},l.prototype.$wrapper=function(t,e){return e?function(t){return new Promise(function(e,n){return t(function(t,n){return void 0===n&&(n=!1),n?null!==t&&e(t):e(t),t},n)})}(t):t(function(t){return t},null)},l.prototype.get=function(t,e,n,o){var i=this;void 0===e&&(e=null),void 0===n&&(n=!1),void 0===o&&(o=!1);var u=o||this.$shouldAsync(e);return this.$wrapper(function(o,u){var c=i.$key(t);return r(function(){return o(n?null:i.$cache.get(c),!0)},function(){var t=i.cache.get(c);return n||null===t||i.$cache.set(c,t),o(t,!0)},function(){return i.$value(e,o,u)})},u)},l.prototype.getMany=function(t,e){var n=this;if(void 0===e&&(e=!1),Array.isArray(t)){var o=t,r={};return o.forEach(function(t){return r[t]=n.get(t,null,e)}),r}for(var i=t,u=!1,c=Object.keys(i),f=c.length,s=0;s<f;s++){var a=c[s];if(n.$shouldAsync(i[a])){u=!0;break}}if(u)return new Promise(function(t,o){var r=c.map(function(t){return n.get(t,i[t],e,!0)});Promise.all(r).then(function(e){var n={};c.forEach(function(t,o){n[t]=e[o]}),t(n)},function(t){return o(t)})})},l.prototype.keys=function(){var t=this;return this.cache.keys().filter(function(e){return e.substr(0,t.prefix.length)===t.prefix}).map(function(e){return e.substr(t.prefix.length)})},l.prototype.all=function(){return this.getMany(this.keys())},l.prototype.put=function(t,e){var n=this;return t=this.$key(t),e=this.$value(e,t),e=void 0===e?null:e,["$cache","cache"].forEach(function(o){return n[o].set(t,e)}),!0},l.prototype.putMany=function(t){var e=this;return i(t,function(t,n){return e.put(n,t)}),!0},l.prototype.switch=function(t,e){return void 0===e&&(e=null),e="boolean"==typeof e?e:!this.get(t,!1),this.put(t,e),e},l.prototype.increment=function(t,e,n){void 0===e&&(e=1),void 0===n&&(n=1/0);var o=+this.get(t,0)+e;return this.put(t,Math.min(o,n)),o},l.prototype.decrement=function(t,e,n){void 0===e&&(e=1),void 0===n&&(n=-(1/0));var o=+this.get(t,0)-e;return this.put(t,Math.max(o,n)),o},l.prototype.remember=function(t,e,n){var o=this;if(void 0===n&&(n=!1),this.$shouldAsync(e))return new Promise(function(r,i){o.get(t,e,n,!0).then(function(e){o.put(t,e),r(e)},function(t){return i(t)})});var r=this.get(t,e,n);return this.put(t,r),r},l.prototype.rememberMany=function(t,e){var n=this;void 0===e&&(e=!1);var o=this.getMany(t,e);return u(o)?new Promise(function(t,e){o.then(function(e){i(e,function(t,e){n.put(e,t)}),t(e)},function(t){return e(t)})}):(i(o,function(t,e){n.put(e,t)}),o)},l.prototype.forget=function(t){var e=this,n=Array.isArray(t)?t:[t];return n.forEach(function(t){t=e.$key(t),["$cache","cache"].forEach(function(n){return e[n].remove(t)})}),!0},l.prototype.flush=function(){return this.forget(this.keys()),this},l.prototype.getPrefix=function(){return this.prefix},l.prototype.setPrefix=function(t){this.prefix=t},l.prototype.getDriver=function(){return this.driver},l.prototype.setDriver=function(t){this.driver=t},l});
